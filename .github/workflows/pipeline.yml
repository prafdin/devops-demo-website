name: DevOps Demo Pipeline

on:
  push:
    branches: [ compose-demo, develop, devsecops ]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
    - name: Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞ GitHub runner..."
        ./test.sh
    
    - name: Build Docker images
      run: |
        echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
        # Frontend (nginx)
        docker build -t ghcr.io/${{ github.repository_owner }}/devops-demo-website:latest .
        docker tag ghcr.io/${{ github.repository_owner }}/devops-demo-website:latest ghcr.io/${{ github.repository_owner }}/devops-demo-website:${{ github.sha }}
        
        # Backend (Flask API)
        docker build -t ghcr.io/${{ github.repository_owner }}/devops-demo-website-backend:latest ./backend
        docker tag ghcr.io/${{ github.repository_owner }}/devops-demo-website-backend:latest ghcr.io/${{ github.repository_owner }}/devops-demo-website-backend:${{ github.sha }}
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: 'ghcr.io/${{ github.repository_owner }}/devops-demo-website:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: 0
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Push Docker images
      run: |
        echo "üì¶ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –≤ registry..."
        # Frontend
        docker push ghcr.io/${{ github.repository_owner }}/devops-demo-website:latest
        docker push ghcr.io/${{ github.repository_owner }}/devops-demo-website:${{ github.sha }}
        
        # Backend
        docker push ghcr.io/${{ github.repository_owner }}/devops-demo-website-backend:latest
        docker push ghcr.io/${{ github.repository_owner }}/devops-demo-website-backend:${{ github.sha }}
    
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Setup Docker environment with Ansible
      run: |
        echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker —á–µ—Ä–µ–∑ Ansible..."
        cd ansible
        ansible-playbook setup.yml
    
    - name: –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è
      env:
        DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
        DEPLOY_USER: ${{ vars.DEPLOY_USER }}
        DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
      run: |
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –≤–µ—Ç–∫–µ
        if [ "${{ github.ref_name }}" = "develop" ]; then
          DEPLOY_ENV="develop"
          echo "üß™ –î–µ–ø–ª–æ–π –≤ –¢–ï–°–¢–û–í–û–ï –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
        else
          DEPLOY_ENV="production"
          echo "üè≠ –î–µ–ø–ª–æ–π –≤ –ü–†–û–î–ê–ö–®–ù –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
        fi
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ Ansible..."
        cd ansible
        ansible-playbook deploy.yml -e deploy_env=$DEPLOY_ENV -e image_tag=${{ github.sha }}
