name: DevOps Demo Pipeline

on:
  push:
    branches: [ cm-demo, develop ]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞ GitHub runner..."
        ./test.sh
      
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Setup environment with Ansible
      run: |
        echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Ansible..."
        cd ansible
        ansible-playbook setup.yml
    
    - name: –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è
      env:
        DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
        DEPLOY_USER: ${{ vars.DEPLOY_USER }}
        DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
      run: |
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –≤–µ—Ç–∫–µ
        if [ "${{ github.ref_name }}" = "develop" ]; then
          ENVIRONMENT="develop"
          echo "üß™ –î–µ–ø–ª–æ–π –≤ –¢–ï–°–¢–û–í–û–ï –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
        else
          ENVIRONMENT="production"
          echo "üè≠ –î–µ–ø–ª–æ–π –≤ –ü–†–û–î–ê–ö–®–ù –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
        fi
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ deploy.sh..."
        ./deploy.sh $ENVIRONMENT