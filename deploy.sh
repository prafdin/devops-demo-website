#!/bin/bash

ENVIRONMENT=${1:-production}

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –¥–µ–º–æ-—Å–∞–π—Ç–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ nginx
if ! command -v nginx &> /dev/null; then
    echo "‚ùå nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    exit 1
fi

if [ "$ENVIRONMENT" = "develop" ]; then
    DEPLOY_DIR="/var/www/demo-test"
    echo "üß™ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –¢–ï–°–¢–û–í–û–ï –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
else
    DEPLOY_DIR="/var/www/demo"
    echo "üè≠ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –ü–†–û–î–ê–ö–®–ù –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–∞–π—Ç–∞
sudo mkdir -p $DEPLOY_DIR

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å–∞–π—Ç–∞ –≤ $DEPLOY_DIR..."
sudo cp index.html $DEPLOY_DIR/

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
echo "‚öôÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx..."
sudo cp nginx.conf /etc/nginx/sites-available/demo-site
sudo ln -sf /etc/nginx/sites-available/demo-site /etc/nginx/sites-enabled/

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx..."
sudo nginx -t

if [ $? -eq 0 ]; then
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx..."
    sudo systemctl reload nginx
    
    echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx"
    exit 1
fi