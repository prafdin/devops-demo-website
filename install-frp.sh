#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ FRP –∫–ª–∏–µ–Ω—Ç–∞
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   sudo ./install-frp.sh [SERVER_ADDR] [AUTH_TOKEN] [USERNAME]
#
# –ü—Ä–∏–º–µ—Ä—ã:
#   sudo ./install-frp.sh course.prafdin.ru mytoken prafdin

set -e

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
SERVER_ADDR=${1:-"course.prafdin.ru"}
AUTH_TOKEN=${2:-"mytoken"}
USERNAME=${3:-"prafdin"}

echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ FRP –∫–ª–∏–µ–Ω—Ç–∞..."
echo "üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:"
echo "   –°–µ—Ä–≤–µ—Ä: $SERVER_ADDR"
echo "   –¢–æ–∫–µ–Ω: ${AUTH_TOKEN:0:8}***"
echo "   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $USERNAME"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if [[ $EUID -ne 0 ]]; then
   echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
   echo ""
   echo "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
   echo "   sudo ./install-frp.sh [SERVER_ADDR] [AUTH_TOKEN] [USERNAME]"
   echo ""
   echo "üîß –ü—Ä–∏–º–µ—Ä—ã:"
   echo "   sudo ./install-frp.sh course.prafdin.ru mytoken prafdin"
   exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è FRP
mkdir -p /etc/frp
mkdir -p /var/log/frp

if command -v frpc >/dev/null 2>&1; then
   echo "‚úÖ FRP –∫–ª–∏–µ–Ω—Ç (frpc) —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(frpc -v 2>/dev/null || echo "–≤–µ—Ä—Å–∏—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞")"
   echo "‚è≠ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
else
   echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FRP –∫–∞–∫ systemd —Å–µ—Ä–≤–∏—Å..."
   curl -fsSL https://gist.github.com/lawrenceching/41244a182307940cc15b45e3c4997346/raw/0576ea85d898c965c3137f7c38f9815e1233e0d1/install-frp-as-systemd-service.sh | bash
fi

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "‚öôÔ∏è  –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
cat > /etc/frp/frpc.toml << EOF
# FRP Client Configuration - Generated by install-frp.sh

serverAddr = "$SERVER_ADDR"
serverPort = 7000

auth.method = "token"
auth.token = "$AUTH_TOKEN"

# –ü—Ä–æ–∫—Å–∏ –¥–ª—è webhook —Å–µ—Ä–≤–µ—Ä–∞
[[proxies]]
name = "hook-$USERNAME"
type = "http"
localIP = "127.0.0.1"
localPort = 8080
customDomains = ["webhook.$USERNAME.$SERVER_ADDR"]

# –ü—Ä–æ–∫—Å–∏ –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
[[proxies]]
name = "app-$USERNAME"
type = "http"
localIP = "127.0.0.1"
localPort = 8181
customDomains = ["app.$USERNAME.$SERVER_ADDR", "app-test.$USERNAME.$SERVER_ADDR"]
EOF

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ /etc/frp/frpc.toml"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chown -R root:root /etc/frp
chmod 644 /etc/frp/frpc.toml
chown -R frp:frp /var/log/frp 2>/dev/null || echo "‚ö†Ô∏è  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å frp –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫)"

echo "üîß –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º systemd –∏ –∑–∞–ø—É—Å–∫–∞–µ–º FRP –∫–ª–∏–µ–Ω—Ç..."
systemctl daemon-reload
systemctl enable frpc
systemctl start frpc
systemctl restart frpc

echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å FRP –∫–ª–∏–µ–Ω—Ç–∞..."
systemctl status frpc --no-pager

echo ""
echo "‚úÖ FRP –∫–ª–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω!"
echo ""
echo "üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   sudo systemctl status frpc     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
echo "   sudo systemctl restart frpc    # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å"
echo "   sudo journalctl -u frpc -f     # –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
echo "   sudo nano /etc/frp/frpc.toml   # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥"
echo ""
echo "üåê URLs –¥–ª—è –≤–∞—à–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
echo "   Webhook URL: http://webhook.$USERNAME.$SERVER_ADDR"
echo "   App URLs: http://app.$USERNAME.$SERVER_ADDR, http://app-test.$USERNAME.$SERVER_ADDR"
echo ""
echo "‚öôÔ∏è  –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ:"
echo "   /etc/frp/frpc.toml"